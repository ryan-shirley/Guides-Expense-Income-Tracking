# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
  # More GitHub Actions for Azure: https://github.com/Azure/actions
  
  name: Build and deploy Laravel to Azure App Service
  
  on:
    push:
      branches:
        - mongo-db-docker
    workflow_dispatch:

  env:
    AZURE_WEBAPP_NAME: 'guides-test'    # set this to your application's name
    NODE_VERSION: '10.x'                # set this to the node version to use
  
  jobs:
    build:
      runs-on: ubuntu-latest
  
      steps:
        - uses: actions/checkout@v2
  
        - name: Setup PHP
          uses: shivammathur/setup-php@v2
          with:
            php-version: '7.4'
            
        - name: Check if composer.json exists
          id: check_files
          uses: andstor/file-existence-action@v1
          with:
            files: "composer.json"
  
        - name: Run composer install if composer.json exists
          if: steps.check_files.outputs.files_exists == 'true'
          run: composer validate --no-check-publish && composer install --prefer-dist --no-progress

         - name: Use Node.js ${{ env.NODE_VERSION }}
            uses: actions/setup-node@v2
            with:
              node-version: ${{ env.NODE_VERSION }}

          - name: npm install, build, and test
            run: |
              # Build and test the project, then
              # deploy to Azure Web App.
              npm install
              npm run build --if-present
              npm run test --if-present

        - name: Archive Release
          uses: thedoctor0/zip-release@master
          with:
            type: 'zip'
            filename: 'build.zip'
            exclusions: '*.git* /*node_modules/* .editorconfig'
        
        - name: Upload artifact for deployment job
          uses: actions/upload-artifact@v2
          with:
            name: php-app
            path: 'build.zip'
  
    deploy:
      runs-on: ubuntu-latest
      needs: build
      environment:
        name: 'production'
        url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
  
      steps:
        - name: Download artifact from build job
          uses: actions/download-artifact@v2
          with:
            name: php-app
  
        - name: 'Deploy to Azure Web App'
          uses: azure/webapps-deploy@v2
          id: deploy-to-webapp
          with:
            app-name: ${{ env.AZURE_WEBAPP_NAME }}
            slot-name: 'production'
            publish-profile: ${{ secrets.AzureAppService_PublishProfile_0c01ab4217f24bd69a06ca72ba73f298 }}
            package: 'build.zip'